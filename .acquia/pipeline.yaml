---
type: default
team: DIT
service: acquia_lift

# The environment container image is used to prepare code versions
# and tooling for tests during pre, post and build stages.
environment_image:
  file: ".acquia/Dockerfile.ci"
  context: "."
  # The build_matrix is only required for testing multiple versions.
  build_matrix:
    base_images:
      - php:7.4-cli-buster # First image is the default.

_orca_steps: &orca_steps
  - steps:
      - |
        cd $ORCA_WORKSPACE
        ../orca/bin/ci/before_install.sh
        # Create the test fixture and place the SUT.
        ../orca/bin/ci/install.sh
        ./bin/travis/install.sh
        # Display details about the fixture.
        ../orca/bin/ci/before_script.sh
        # Run the test script.
        ../orca/bin/ci/script.sh
        ./bin/travis/script.sh
        ../orca/bin/ci/before_cache.sh

# -- Continuous Integration --
# Pre-build runs after building the environment image, and relies on it to
# run its sub-stages' steps inside of the environment container.
pre_build:
  static_code_analysis:
    - args: --env ORCA_JOB=STATIC_CODE_ANALYSIS
      <<: *orca_steps
#  integrated_test_on_oldest_supported:
#    - args: --env ORCA_JOB=INTEGRATED_TEST_ON_OLDEST_SUPPORTED
#      <<: *orca_steps
#  #  integrated_test_on_latest_lts:
#  #    - args: --env ORCA_JOB=INTEGRATED_TEST_ON_LATEST_LTS
#  #      <<: *orca_steps
#  integrated_test_on_prev_minor:
#    - args: --env ORCA_JOB=INTEGRATED_TEST_ON_PREVIOUS_MINOR
#      <<: *orca_steps
#  integrated_test_from_prev_minor:
#    - args: --env ORCA_JOB=INTEGRATED_UPGRADE_TEST_FROM_PREVIOUS_MINOR
#      <<: *orca_steps
#  isolated_test_on_current:
#    - args: --env ORCA_JOB=ISOLATED_TEST_ON_CURRENT
#      <<: *orca_steps
#  integrated_test_on_current:
#    - args: --env ORCA_JOB=INTEGRATED_TEST_ON_CURRENT
#      <<: *orca_steps
#  integrated_test_to_next_minor:
#    - args: --env ORCA_JOB=INTEGRATED_UPGRADE_TEST_TO_NEXT_MINOR
#      <<: *orca_steps
#  integrated_test_to_next_minor_dev:
#    - args: --env ORCA_JOB=INTEGRATED_UPGRADE_TEST_TO_NEXT_MINOR_DEV
#      <<: *orca_steps
#  isolated_test_on_current_dev:
#    - args: --env ORCA_JOB=ISOLATED_TEST_ON_CURRENT_DEV
#      <<: *orca_steps
##  integrated_test_on_current_dev:
##    - args: --env ORCA_JOB=INTEGRATED_TEST_ON_CURRENT_DEV
##      <<: *orca_steps
  deprecated_code_scan:
    - args: --env ORCA_JOB=DEPRECATED_CODE_SCAN
      <<: *orca_steps
  #  deprecated_code_scan_w_contrib:
  #    - args: --env ORCA_JOB=DEPRECATED_CODE_SCAN_W_CONTRIB
  #      <<: *orca_steps
  isolated_test_on_next_minor:
    - args: --env ORCA_JOB=ISOLATED_TEST_ON_NEXT_MINOR
      <<: *orca_steps
  integrated_test_on_next_minor:
    - args: --env ORCA_JOB=INTEGRATED_TEST_ON_NEXT_MINOR
      <<: *orca_steps
  isolated_test_on_next_minor_dev:
    - args: --env ORCA_JOB=ISOLATED_TEST_ON_NEXT_MINOR_DEV
      <<: *orca_steps
  integrated_test_on_next_minor_dev:
    - args: --env ORCA_JOB=INTEGRATED_TEST_ON_NEXT_MINOR_DEV
      <<: *orca_steps
  isolated_upgrade_test_to_next_major_beta_or_later:
    - args: --env ORCA_JOB=ISOLATED_UPGRADE_TEST_TO_NEXT_MAJOR_BETA_OR_LATER
      <<: *orca_steps
  isolated_upgrade_test_to_next_major_dev:
    - args: --env ORCA_JOB=ISOLATED_UPGRADE_TEST_TO_NEXT_MAJOR_DEV
      <<: *orca_steps

  security_composition_analysis:
    required: false

after_success:
  - steps:
      - cd $ORCA_WORKSPACE && ../orca/bin/travis/after_success.sh

after_failure:
  - steps:
      - cd $ORCA_WORKSPACE && ../orca/bin/travis/after_failure.sh

# -- Slack Bot Integration --
notify:
  channel: drupal-integration-eng
